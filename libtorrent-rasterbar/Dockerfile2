FROM alpine AS builder
ARG LIBTORRENT_VERSION
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories \
    && apk add --update --no-cache \
       boost-dev \
       build-base \
       openssl-dev \
       cmake \
       ninja \
    && rm -rf /tmp/* /var/cache/apk/*
COPY libtorrent-${LIBTORRENT_VERSION} /tmp/libtorrent
RUN cd /tmp/libtorrent \
    && ls -al \
    && cmake \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_CXX_STANDARD=17 \
        -B release \
        -G Ninja \
    && cd release \
    && ninja \
    && ls -al \
    && mkdir /out \
    && cp -d libtorrent-rasterbar.so* /out

FROM scratch
COPY --from=builder /out /usr/lib

